---

title: "Solr und MyCoRe"
mcr_version: ['2023.06', '2024.06']
author: ['Jens Kupferschmidt', 'Kathleen Neumann', 'Robert Stephan', 'Sebastian Hofmann']
description: "
Dieses Kapitel beschäftigt sich mit der Einbindung der Apache Solr-Suchmaschine in MyCoRe.
Das MyCoRe-Release 2023.06 LTS wurde erfolgreich mit Solr 8.11.1 getestet und das 2024.06 LTS wird mit Solr 9.6 getestet.
"
date: "2024-09-03"

---

<h2>Solr Konfiguration für MyCoRe</h2>
<p>
    Falls noch kein Solr Server zur Verfügung steht, kann er gemäß der Anleitung im Abschnitt
    <a href="{{< ref gs_solr >}}">Einrichtung eines Solr-Servers</a>
    installiert werden.
</p>

<h3>Begrifflichkeiten im Zusammenhang mit MyCoRe</h3>
<p>Im Zusammenhang mit der Nutzung der Kommandos zur Konfiguration von SOLR-Cores in MyCoRe sind einige Begiffe
    zu definieren. Dies soll Missverständnisse bei der Nutzung vermeiden.
</p>
<dl>
    <dt>Configuration Set - <code>config_set</code></dt>
    <dd>
        Beschreibt ein vorgefertigtes Template, welches alternativ zu dem in SOLR mitgelieferten
        <code>_default</code>-Template für alle MyCoRe-Anwendungen zum Erstellen eines neuen Cores eingesetzt
        werden kann. Seit MyCoRe 2024.06 LTS werden die config_sets zusammen mit der MyCoRe-SOLR-Komponente
        ausgeliefert.
    </dd>

    <dt>Core Configuration Type - core_config_type</dt>
    <dd>Bezeichnet die Art der Konfiguration. Festgelegt wurden die Arten <code>main</code> und
        <code> classification</code>. Die Typangabe beschreibt den Pfad zu den JSON-API-Vorlagen in den einzelnen
        MyCoRe-Modulen (z. B.<em>.../{modulname}/config/solr/{core_config_type}/solr-schema.json</em>).
        Seit MyCoRe 2024.06 LTS können auch eigene Core-Typen definiert werden. Diese bestimmen jetzt auch in welchen
        Kern die Daten indexiert werden. Es ist auch möglich, dass zwei Kerne den gleichen Typ haben und somit die
        gleichen Daten parallel in zwei Kernen indexiert werden.
    </dd>

    <dt>CoreId - core_id</dt>
    <dd>ist eine fiktive ID, mit der die einzelnen Cores einer Anwendung bezeichnet werden und mit der ihnen
        spezifische Konfigurationen zugewiesen werden können. Standardmäßig werden diese gleichlautend wie die dazu
        passenden Konfigurationstypen mit <code>main</code> und <code>classification</code> bezeichnet.
    </dd>

    <dt>CoreName - core_name</dt>
    <dd>ist der konkrete Name des Cores aus Sicht SOLR. Dies ist auch der Name, unter dem der Core tatsächlich in SOLR
        zu finden ist.
    </dd>
</dl>

<p>
    Nun müssen für jede MyCoRe-Anwendung ein oder mehrere Solr-Cores angelegt werden. Die Konfiguration der Kerne
    unterscheidet sich je nach Solr Installation. Wird Solr als Cloud-Installation betrieben, so wird die Konfiguration
    über die seit 2024.06 LTS verfügbaren Solr-Cloud-CLI-Kommandos durchgeführt. Für eine reguläre Solr-Installation
    werden Templates (Configuration Sets) für die Basiskonfiguration durch MyCoRe über GitHub bereitgestellt.

</p>

<h3>Grundlegende Konfiguration</h3>
<p>
    Zunächst muss die Solr-Server-URL der MyCoRe-Anwendung über ein Property bekannt
    gemacht werden (siehe <a href="{{< ref gs_properties >}}">MyCoRe-Konfigurationsverzeichnis</a>).
    Weiterhin können für die einzelnen <em>CoreIds</em> der <em>CoreName</em> und falls abweichend auch die URLs
    definiert werden.
    Die <em>CoreId</em> <code>main</code> ist dabei immer erforderlich. Weitere <em>CoreIds</em> wie
    <code>classification</code> sind optional.

    Es ist auch möglich, den Core auf einem anderen Solr Server zu erstellen. In diesem Fall
    muss zusätzlich das Property <code>MCR.Solr.Core.{core_id}.ServerURL</code>
    gesetzt werden. Somit können Solr-Cores auch auf verschiedenen physischen Hosts liegen.
</p>

{{< highlight shell "linenos=table">}}
MCR.Solr.ServerURL=http://localhost:8983/
MCR.Solr.Core.main.Name=my_core_name
MCR.Solr.Core.main.ServerURL=%MCR.Solr.ServerURL%
...
{{< /highlight >}}

<p>
    Alternativ können die <em>CoreIds</em> über die MyCoRe-CLI registriert werden. Diese Einstelllungen sind jedoch
    nicht persistent.
</p>

<p>
    Bis MyCoRe 2023.06 LTS:
</p>
{{< highlight shell "linenos=table">}}
    register solr core with name {core_name} as core main
    register solr core with name my_core_name as core main
{{< /highlight >}}


<p>
    Ab MyCoRe 2024.06 LTS:
</p>
{{< highlight shell "linenos=table">}}
    register solr core with name {0} as core {1}
    add type {0} to solr core {1}

    register solr core with name my_core_name as core main
    add type main to solr core main
{{< /highlight >}}

<h4>Authentifizierung</h4>
<p>
    Ab Version 2024.06 bietet MyCoRe die Möglichkeit, Solr-Server mit einer Authentifizierung zu nutzen.
    Im Solr können fein granular für verschiedene Funktionen und Cores die benötigten Rechten konfiguriert werden.
    Für die Administration, Suche und Indexierung können in MyCoRe verschiedene Logins über folgende
    Properties gesetzt werden:
</p>

{{< highlight shell "linenos=table">}}
 MCR.Solr.Server.Auth.Admin.Class=org.mycore.solr.auth.MCRSolrBasicPropertyAuthentication
 MCR.Solr.Server.Auth.Admin.Username=meinAdmin
 MCR.Solr.Server.Auth.Admin.Password=geheim123

 MCR.Solr.Server.Auth.Index.Class=org.mycore.solr.auth.MCRSolrBasicPropertyAuthentication
 MCR.Solr.Server.Auth.Index.Username=meinIndexer
 MCR.Solr.Server.Auth.Index.Password=geheim321

 MCR.Solr.Server.Auth.Search.Class=org.mycore.solr.auth.MCRSolrBasicPropertyAuthentication
 MCR.Solr.Server.Auth.Search.Username=meinSucher
 MCR.Solr.Server.Auth.Search.Password=geheim!
{{< /highlight >}}

<p>
    Die Authentifizierung wird über die
    <a href="https://solr.apache.org/guide/solr/latest/deployment-guide/basic-authentication-plugin.html">Basic Authentication</a>
    von Solr realisiert. Dazu wird die Konfigurationsdatei <code>security.json</code> auf dem Solr Server gepflegt.
    Die Authentifizierung erfolgt über das Senden eines <code>Authorization</code>-Headers in den Solr-Requests.
    Wenn die Properties nicht gesetzt sind, führt MyCoRe keine Authentifizierung durch.
</p>

<p>
    Der Search Nutzer benötigt das Recht <code>read</code> der Indexer die Rechte <code>read</code> und
    <code>update</code> und der Admin die Rechte <code>all</code>.
    Wenn mehrere Anwendungen auf den gleichen Solr-Server zugreifen, ist es ratsam, für jede Anwendung eigene Nutzer
    mit den entsprechenden Rechten passend zu den jeweiligen Kernen/Collections zu erstellen.
</p>

<h3>Reguläre Solr-Installation</h3>

<h4>Configuration Sets laden</h4>
<p>
    Die Basis-Konfiguration eines Solr-Cores erfolgt über <strong>Configuration Sets</strong>.
    Die Konfigurationen sind je nach MyCoRe-Version unterschiedlich. Ab 2024.06 LTS werden die Konfigurationen direkt
    im Modul <code>mycore-solr</code> bereitgestellt. Für ältere Versionen müssen die Konfigurationen aus einen anderen
    Repository geladen werden.
<p>
<h5>bis MyCoRe 2023.06 LTS</h5>
<p>
    Bei GitHub werden verschiedene
    <a href="https://github.com/search?q=topic%3Asolr-core+org%3AMyCoRe-Org">MyCoRe-Config-Sets</a>
    zur Verfügung gestellt. Für den Solr-Core vom Typ <code>main</code> wird das
    <a href="https://github.com/MyCoRe-Org/mycore_solr_configset_main">mycore_solr_configset_main</a>
    benötigt.
</p>
<h5>ab MyCoRe 2024.06 LTS</h5>
<p>
    Die <a href="https://github.com/MyCoRe-Org/mycore/tree/main/mycore-solr/src/main/resources/configset">MyCoRe-Config-Sets</a>
    sind direkt im Modul <code>mycore-solr</code> enthalten.
</p>
<p>
    Um das Set in den Solr-Server zu integrieren, können folgende Kommandos ausgeführt werden:
</p>

{{< highlight shell "linenos=table">}}
git clone https://github.com/MyCoRe-Org/mycore
cp -R mycore/mycore-solr/src/main/resources/configset ../solr/server/solr/configsets
cd ../solr/server/solr/configsets
{{< /highlight >}}

<p>
    Alternativ kann das Verzeichnis auch manuell heruntergeladen und in diesen Ordner kopiert werden. Analog kann
    dies für das Klassifikations-Set aufgerufen werden:
</p>

{{< highlight shell "linenos=table">}}
git clone https://github.com/MyCoRe-Org/mycore_solr_configset_classification.git mycore_classification
{{< /highlight>}}


<h4>Standard Solr Core (main) erzeugen</h4>
<p>
    Basierend auf dem bereitgestellten Configuration Set wird nun ein Solr Core erzeugt.
    Als Name des <strong>main</strong> Cores kann der Name der MyCoRe-Anwendung gewählt werden.
</p>

{{< highlight shell "linenos=table">}}
.../solr/bin/solr create -c {core_name} -d {config_set}
.../solr/bin/solr create -c my_core_name -d mycore_main
{{< /highlight >}}

<h3>Solr-Cloud-Installation (ab MyCoRe 2024.06 LTS)</h3>

<p>
    Seit MyCoRe 2024.06 LTS bietet MyCoRe die Möglichkeit, die Configuration Sets direkt in die Solr-Cloud zu laden und
    anschließend die Kerne(Collections) zu erstellen. Hierfür wird die Solr-ConfigSet-API und die Solr-Collection-API
    verwendet.
</p>

<h4>Configuration Sets laden</h4>

<p>
    Die Configuration Sets mycore_main und mycore_classification sind direkt im Modul <code>mycore-solr</code> enthalten
    und können direkt per MyCoRe-CLI geladen werden. Wichtig ist dafür das für den passenden Kern das richtige ConfigSet
    festgelegt ist. Dies kann über das Property <code>MCR.Solr.Core.{core_id}.ConfigSetTemplate</code> erfolgen.
    Für die Kerne <code>main</code> und <code>classification</code> sind die ConfigSets <code>mycore_main</code> und
    <code>mycore_classification</code> in der MyCoRe-SOLR-Komponente vordefiniert.
</p>

{{< highlight shell "linenos=table">}}
# eigener Kern
MCR.Solr.Core.custom.Name=my_core_name
MCR.Solr.Core.custom.ConfigSetTemplate=mycore_main

# in MyCoRe vordefiniert
MCR.Solr.Core.main.ConfigSetTemplate=mycore_main
MCR.Solr.Core.classification.ConfigSetTemplate=mycore_classification
{{< /highlight >}}

<p>
    Über die MyCoRe-CLI kann das ConfigSet geladen werden:
</p>

{{< highlight shell "linenos=table">}}

upload local config set for {0}

upload local config set for main

{{< /highlight >}}

<p>
    Die ConfigSets können nicht für einen neuen Kern wiederverwendet werden, da nach dem Überspielen mit der Schema-API
    auch das ConfigSet modifiziert wird. Daher werden die ConfigSets in der Solr-Cloud unter einem bestimmten
    modifizierten Namen abgelegt, welcher sich aus dem Muster $CoreId_$ConfigSetName zusammen setzt. Das ConfigSet
    <code>mycore_main</code> wird also in der Solr-Cloud unter dem Namen <code>main_mycore_main</code> abgelegt.
</p>

<h4>Erzeugen des Solr-Cores</h4>

<p>
    Die MyCoRe-CLI bietet die Möglichkeit, die Solr-Cores direkt in der Solr-Cloud zu erstellen. Hierfür wird die
    Solr-Collection-API verwendet. Folgende Kommandos können verwendet werden:
</p>

{{< highlight shell "linenos=table">}}

create collection for core {0}

create collection for core main

{{< /highlight >}}

<p>
    Die Collection wird mit dem Standardwert für die Anzahl der Shards erstellt. Diese können über
    das Property <code>MCR.Solr.Core.{core_id}.ShardCount</code> angepasst werden.
</p>

<h3>Solr Schema laden</h3>

<p>
    Anschließend kann über die SOLR-Web-Oberfläche geprüft werden, ob der Core richtig angelegt wurde
    (<a href="http://localhost:8983/solr/#/~cores">http://localhost:8983/solr/#/~cores</a>).
</p>

<p>
    Über das MyCoRe-Kommando
    <code>show solr configuration</code>
    kann eine Liste der zu setzenden Properties in der CLI angezeigt werden.
</p>


<p>
    Da verschiedene MyCoRe Komponenten und Module individuelle Suchfelder und Datentypen benötigen, können diese
    direkt in den Modulen definiert werden. Mittels eines MyCoRe-Kommandos werden diese Definitonsdateien ausgelesen
    und über die <a href="https://lucene.apache.org/solr/guide/8_11/schema-api.html">Solr Schema API</a> in den Core
    geschrieben.
</p>

<p>
    Die Konfiguration der Solr-Suchfelder, Request-Handler, ... wurden seit MyCoRe 2018.06 LTS
    auf die Module und Komponenten aufgeteilt, in denen sie verwendet werden. Die Basisfelder / -Konfiguration
    für alle MyCoRe-Anwendungen befindet sich in der Komponente <code>mycore-solr</code>.
</p>

<p>
    Je nach Anwendungsfall kann es sein, dass neben dem Solr-Core vom Typ
    <code>main</code> weitere Definitionen für andere Core Typen (z. B.
    <code>classification</code>) erstellt werden müssen.
</p>

{{< highlight shell "linenos=table">}}
{mycore-module}/src/main/resources/components/{module_name}/config/solr
or
{application-module}/src/main/resources/config/{application-module}/solr

 .../main - the core that use each MyCoRe application
   .../solr-schema.json - vorhanden, wenn das Modul das Solr-Schema erweitert
   .../solr-config.json - vorhanden, wenn das Modul die Solr-Konfiguration erweitert

 .../{other_type} - other core definitions
   .../solr-schema.json - vorhanden, wenn das Modul das Solr-Schema erweitert
   .../solr-config.json - vorhanden, wenn das Modul die Solr-Konfiguration erweitert
{{< /highlight >}}
</p>

<p>
    Die JSON-Dateien bestehen aus Json-Arrays, die Kommandos der Solr-Schema bzw. Solr-Configuration API
    enthalten.
    Sollen bereits bestehende / in MyCoRe vorhandene Felder oder ihre Definition geändert werden, kann
    dies über <code>replace</code>-Anweisungen in den JSON-Konfigurationsdateien erfolgen.
</p>
<p>
    In Solr wird die anwenderseitige Konfiguration in der gesonderten Datei <em>configoverlay.json</em>
    im jeweiligen Kern abgelegt. Hier können Einträge aus den Gruppen stehen, welche im Property
    <code>MCR.Solr.ObserverConfigTypes</code> definiert sind. Ggf. sind in diesen Definitionen auch Verweise
    auf eigene SOLR-FieldTypes vorhanden. Diese Elemente (z. B. ein RequestHandler) müssen beim Reload der
    SOLR-Kern-Konfiguration vorher gelöscht werden. Um nicht all Konfigurationen wahllos zu löschen, sind
    diese im <em>mycore.properties</em> des jeweiligen Datenmodells explizit zum Löschen anzugeben.
</p>

{{< highlight shell "linenos=table">}}
MCR.Solr.ObserverConfigTypes.{observedType}.toClean={my_request_handler},...
{{< /highlight >}}

<p>
    Über ein MyCoRe-CLI Kommando wird die Konfiguration geladen. Im Normalfall lautet das Kommando:
</p>

{{< highlight shell "linenos=table">}}
mycore.sh reload solr configuration {core_config_type} in core {core_id}
mycore.sh reload solr configuration main in core main
{{< /highlight >}}

<p>
    Anschließend sollte noch einmal über die Solr-Web-Oberfläche geprüft werden, ob der Core vollständig
    konfiguriert wurde.
    Weiterhin sollte im MyCoRe-Log / in der Kommandozeile geprüft werden, ob Solr sämtliche
    Konfigurationskommandos ausgeführt hat.
    Ist alles okay, so ist der Core betriebsbereit.
</p>
<p>
    (siehe
    <a href="https://lucene.apache.org/solr/guide/8_9/solr-control-script-reference.html">Solr Control Script
        Reference</a>,
    <a href="https://lucene.apache.org/solr/guide/8_9/schema-api.html">Schema API</a> und
    <a href="https://lucene.apache.org/solr/guide/8_9/config-api.html">Config API</a>)
</p>

<h2>Erstellen und Hochladen eigener Configsets in die Solr-Cloud</h2>
<p>
    Mit MyCoRe 2024.06 LTS können eigene Configsets in die Solr-Cloud hochgeladen werden. Hierfür wird die
    Solr-ConfigSet-API verwendet.
    Die ConfigSet-API erwartet ein ZIP-Archiv, welches die Konfigurationsdateien enthält, dass bedeutet MyCoRe muss
    die Konfiguration aus einer Quelle laden können und diese in ein ZIP-Archiv packen und dieses an die Solr-Cloud
    senden.
    Hierfür wird das Interface <code>MCRSolrConfigSetProvider</code> verwendet. Dieses Interface muss von einer
    Klasse implementiert werden, die die Konfigurationen bereitstellt.
    Für den Standardfall, dass die Konfigurationen aus dem Klassenpfad zu laden sind, liefert MyCoRe die Klasse
    <code>MCRSolrResourceConfigSetProvider</code>.
    Eine Beispielkonfiguration kann in der MyCoRe-SOLR-Komponente gefunden werden:
</p>

{{< highlight properties "linenos=table">}}

MCR.Solr.ConfigSet.mycore_classification.Class=org.mycore.solr.cloud.configsets.MCRSolrResourceConfigSetProvider
MCR.Solr.ConfigSet.mycore_classification.Files=managed-schema,solrconfig.xml,stopwords.txt,synonyms.txt
MCR.Solr.ConfigSet.mycore_classification.Base=configset/mycore_main/conf/

{{< /highlight >}}

<p>
    Base stellt den Pfad zu den Konfigurationsdateien dar. Die Dateien welche in Files aufgeführt sind, werden in ein
    ZIP-Archiv gepackt und an die Solr-Cloud gesendet. Die Dateien werden über den
    <a href="{{<ref basics_resources>}}">ResourceResolver</a>geladen.
</p>

<h2>Textextraktion mit Tika</h2>
<p>
    Standardmäßig findet die Textextraktion aus den Dokumenten innerhalb von Solr statt. Jedoch raten die Entwickler von
    Solr davon ab, die Textextraktion im produktiven Betrieb zu nutzen und empfehlen die Textextraktion vorab
    durchzuführen.
    Hierfür kann das Property <code>MCR.Solr.Indexer.File.AccumulatorList</code> genutzt werden. Dieses Property
    erwartet eine Liste von Klassen, welche zusätzliche SOLR-Felder aus Dateien extrahieren und für die Indexierung
    bereitstellen.
    Für die Textextraktion mit Tika kann die Klasse
    <code>org.mycore.solr.index.file.tika.MCRSolrRemoteTikaAccumulator</code> verwendet werden. Diese Klasse sendet
    die Dateien an einen Tika-Server, welcher die Textextraktion durchführt. Die extrahierten Texte werden als JSON
    an die MyCoRe-Anwendung zurückgegeben. Anschließend wird für jeden JSON-Key in der Antwort ein
    <code>MCRTikaMapper</code> verwendet, um die extrahierten Texte verschiedenen Solr-Feldern zuzuweisen.

    Eine Beispielkonfiguration sieht wie folgt aus:
{{< highlight properties "linenos=table">}}

 # In MyCoRe vordefiniert
 MCR.Solr.Indexer.File.AccumulatorList=org.mycore.solr.index.file.tika.MCRSolrRemoteTikaAccumulator

 # Standard Mapper
 MCR.Solr.Tika.Mapper.Default.Class=org.mycore.solr.index.file.tika.MCRTikaNOPMapper

 # Mapper für das Feld X-TIKA:content
 MCR.Solr.Tika.Mapper.x_tika_content.Class=org.mycore.solr.index.file.tika.MCRSimpleTikaMapper
 MCR.Solr.Tika.Mapper.x_tika_content.StripNamespace=true
 MCR.Solr.Tika.Mapper.x_tika_content.MultiValueField=true

 # (nicht vordefiniert) Properties um Tika zu konfigurieren
 # Aktivierung des Accumulators durch das setzen der URL
 MCR.Solr.Tika.ServerURL=https://mein-tika-server.de:9998/tika
 # keine Dateien mehr an solr senden
 MCR.Solr.FileIndexStrategy=org.mycore.solr.index.file.tika.MCRTikaSolrFileStrategy
 # maximale Dateigröße in Byte z.B. 1GB
 MCR.Solr.Tika.MaxFileSize=1073741824
{{< /highlight >}}
</p>

<p>
  Der SimpleTikaMapper ist ein einfacher Mapper, welcher die extrahierten Texte in ein Solr-Feld schreibt. Ein JSON-Dokument
  von Tika sieht wie folgt aus:
</p>

{{< highlight json "linenos=table">}}
{
    ....
    "X-TIKA:content": "Der extrahierte Text",
    "access_permission:can_modify": "true",
    "pdf:docinfo:producer": "iText® 7.1.15 ©2000-2021 iText Group NV (AGPL-version)",
    "pdf:docinfo:created": "2021-08-02T14:14:13Z",
    "pdf:containsDamagedFont": "false"
}
{{< /highlight >}}

<p>
    In der Beispielkonfiguration von oben ist der Default-Mapper ein <code>MCRTikaNOPMapper</code>
    (MCRTikaNoOperationMapper). Dieser Mapper ignoriert den JSON-Key für den es konfiguriert ist.
    Für den <code>x_tika_content</code> Key wird der <code>MCRSimpleTikaMapper</code> verwendet. Dieser Mapper schreibt
    den extrahierten Text in das Solr-Feld mit dem angepassten Namen des JSON-Keys. Dabei werden alle Zeichen die keine
    Buchstaben oder Zahlen sind entfernt und der Text in Kleinbuchstaben umgewandelt. Außerdem besteht die Möglichkeit
    den Namespace des JSON-Keys zu entfernen. Je nach dem ob der Wert des JSON-Keys ein Array ist, kann das Feld als
    MultiValue-Feld gesetzt werden (MultiValueField=true) oder ob der Wert als String konkateniert werden soll.
    Aus dem Beispiel JSON-Dokument wird also der Wert des <code>x_tika_content</code> Keys in das
    Solr-Feld <code>content</code> geschrieben.
</p>

{{< highlight xml "linenos=table">}}
...
<field name="content">Der extrahierte Text</field>
...
{{< /highlight >}}

<h2>Das Solr-Document</h2>
<p>
    Die in Solr zu speichernden Daten werden als Solr-Document über eine Kette von XSLT-Transformationen generiert.
    Hierfür ist das Property <code>MCR.URIResolver.xslImports.solr-document</code>
    zuständig. Grundsätzlich in der Kette enthalten sind die Stylesheets <code>solr-basetemplate.xsl</code>
    und <code>mycoreobject-dynamicfields.xsl</code>. Weitere Transformer können dieser Kette angefügt werden (siehe
    Beispielcode).
    Der an Solr ausgehende Datenstrom läßt sich im Web-Browser mit der URL
    <code>http://{myapp}/receive/{mycore_id}?XSL.Style=solrdocument</code> überprüfen.
</p>

{{< highlight xml "linenos=table">}}<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="3.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
                exclude-result-prefixes="xlink mcrxsl">

    <xsl:import href="xslImport:solr-document:viaf2solr.xsl"/>

    <xsl:template match="mycoreobject[contains(@ID,'_{my_datamodel}_')]">
        <xsl:apply-imports/>
        <!-- field name="viaf_name_all" type="text_general" multiValued="true" stored="true" -->
        <xsl:for-each select="./metadata/def.preferredName/preferredName">
            <field name="viaf_name_all">
                <xsl:value-of select="fullname/text()"/>
            </field>
        </xsl:for-each>
        ...
    </xsl:template>
</xsl:stylesheet>
        {{< /highlight >}}


        <p>
            Über verschiedene <code>rebuild</code> Kommandos (siehe <a href="{{< ref "#solr_commands" >}}">Kommandos
            zur Arbeit mit Solr</a>)
            können die Daten in den Solr Core eingespielt werden. Um alle Daten zu indexieren, kann folgendes Kommando
            verwendet werden:
        </p>
        <p>
{{< highlight shell "linenos=table">}}
 rebuild solr metadata and content index in core main
{{< /highlight >}}
        </p>

        <h2>Eigene Request-Handler einbinden</h2>
        <p>MyCoRe verhindert grundsätzlich den Gebrauch eigener Request-Handler solange diese nicht MyCoRe bekannt
            sind. Grundsätzlich sind nur die Handler <code>/select</code> und <code>/update</code> aus
            Sicherheitsgründen
            zugelassen. Sollen weitere Handler benutzt werden, so müssen diese im Property <code>MCR.Solr.Proxy.WhiteList</code>
            hinzugefügt werden. Dies kann mit folgender Konfiguration erfolgen:</p>
        <p>
{{< highlight shell "linenos=table">}}
 MCR.Solr.Proxy.WhiteList=%MCR.Solr.Proxy.WhiteList%,/myhandler
{{< /highlight >}}
        </p>
        <!-- p>[ToDo] Beispiel Autosuggestion</p -->

        <h2>Solr und Content Security Policy</h2>
        <p>Mit Solr8 kommt bei den Responses die <a href="https://www.w3.org/TR/CSP3/" target="_blank">Content Security
            Policy (CSP)</a>
            im Header zum tragen. Diese Policies werden in MyCoRe an die
            Layout-Komponenten weiter gegeben. Nutzt die Webseite externe Referenzen, kann das zu Konflikten führen. Um
            die CSP zu
            überschreiben, wurde das folgende Property eingeführt. Diese kann die CSP aus Solr ersetzen oder, wenn es
            leer ist, diese
            abschalten.
        </p>
{{< highlight shell "linenos=table">}}
  MCR.Solr.HTTPResponseHeader.Content-Security-Policy=default-src 'none'; base-uri 'none'; connect-src 'self';
  form-action 'self'; font-src 'self'; frame-ancestors 'none'; img-src 'self'; media-src 'self'; style-src 'self'
  'unsafe-inline'; script-src 'self' 'unsafe-inline' https://...; worker-src 'self';
{{< /highlight >}}

        <h2>Properties für die Solr-Komponente</h2>
        <div class="table-responsive">
            <table class="table table-condensed solr-properties-table">
                <thead>
                <tr>
                    <th>Property</th>
                    <th>Bedeutung</th>
                    <th>in App.-Config</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>
                        MCR.Solr.ServerURL
                    </td>
                    <td>
                        default URL für den Solr-Server, z.B.
                        <code>http://mysolr.de:8983/</code>
                        (ohne
                        <strong>/solr</strong>
                        am Ende)
                    </td>
                    <td>
                        <strong>required</strong>
                    </td>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.Core.{core_id}.Name
                    </td>
                    <td>Name des Solr Cores (wird Pfadbestandteil der Solr-URL zum Core)</td>
                    <td>
                        <strong>required</strong>
                    </td>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.Core.{core_id}.ServerURL
                    </td>
                    <td>Basis-URL des Solr-Servers, falls der Core nicht auf dem Standard-Server (s.o.) installiert
                        wurde
                    </td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.Core.{core_id}.ShardCount
                    </td>
                    <td>
                        Beim Erschaffen eines Solr-Cores in der Solr-Cloud wird die Anzahl der Shards festgelegt.
                    </td>
                    <td>
                        <strong>optional</strong> default=1
                    </td>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.Core.{core_id}.ConfigSetTemplate
                    </td>
                    <td>
                        Name des Configuration Sets, das für den Core verwendet werden soll
                    </td>
                    <td>
                        <strong>required</strong>
                    </td>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.ConfigSet.{config_set_id}.Class
                    </td>
                    <td>
                        Klasse, die die Konfigurationen für das ConfigSet bereitstellt
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.Indexer.File.AccumulatorList
                    </td>
                    <td>
                        Eine Liste von Klassen, welche zusätzliche Felder für die Indexierung bereitstellen. Z.B.
                        <code>org.mycore.mets.solr.MCRSolrAltoExtractor</code> - Extrahiert Texte aus ALTO-Dateien.
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.Indexer.BulkSize
                    </td>
                    <td>default=100 ; Die Anzahl der Objekte, die mit einem Mal an Solr geschickt werden.</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.Indexer.ThreadCount
                    </td>
                    <td>default=4 ; Anzahl der benutzten Threads</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.XMLProtocolVersion
                    </td>
                    <td>current=4.5</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.SelectProxy.MaxConnections
                    </td>
                    <td>default=20 ; max. Anzahl der Verbindungen zum Solr-Server für select</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.SelectPath
                    </td>
                    <td>default=/select</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.UpdatePath
                    </td>
                    <td>default=/update</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.ExtractPath
                    </td>
                    <td>default=/update/extract</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.Proxy.WhiteList
                    </td>
                    <td>default=/select ; der Proxy akzeptiert nur die Liste davon</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.SolrClient.ConnectionTimeout
                    </td>
                    <td>default=0</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.SolrClient.SocketTimeout
                    </td>
                    <td>default=50000</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.ConcurrentUpdateSolrClient.Enabled
                    </td>
                    <td>default=true ; soll das Update parallel erfolgen?</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.ConcurrentUpdateSolrClient.QueueSize
                    </td>
                    <td>default=100</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.ConcurrentUpdateSolrClient.ThreadCount
                    </td>
                    <td>
                        Wert entspricht dem Property
                        <code>MCR.Solr.Indexer.ThreadCount</code>
                    </td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.SolrInputDocument.Factory
                    </td>
                    <td>default=org.mycore.solr.index.document.MCRSolrTransformerInputDocumentFactory</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.SolrInputDocument.Transformer
                    </td>
                    <td>default=mycoreobject-solrdocument</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.SolrInputDocument.Path.Factory
                    </td>
                    <td>default=org.mycore.solr.index.file.MCRSolrPathDocumentFactory</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.IndexHandler.Factory
                    </td>
                    <td>default=org.mycore.solr.index.handlers.MCRSolrLazyInputDocumentHandlerFactory</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.FileIndexStrategy
                    </td>
                    <td>default=org.mycore.solr.index.strategy.MCRSolrMimeTypeStrategie</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.MimeTypeStrategy.Pattern
                    </td>
                    <td>default=image/.*</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.DynamicFields
                    </td>
                    <td>
                        default=true ; erzeugt auch dynamische Felder für Solr
                        <br/>
                        Es sollte geprüft werden, ob die Übertragung dynamischer Felder in der speziellen Anwendung
                        erforderlich ist.
                        Andernfalls sollte der Wert auf
                        <code>false</code>
                        gestellt werden.
                    </td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.ContentBaseFields
                    </td>
                    <td>eine Liste von Feldnamen für allgemeine Derivate-Metadaten</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.AVExtenderFields
                    </td>
                    <td>eine Liste von Feldnamen für Video-Derivate-Metadaten</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.TikaFields
                    </td>
                    <td>eine Liste von Feldnamen für Tika-Metadaten</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.JoinQueryFields
                    </td>
                    <td>
                        enthält die Liste der Properties<br/>
                        <code>MCR.Solr.ContentBaseFields</code>
                        ,
                        <code>MCR.Solr.AVExtenderFields</code>
                        ,
                        <code>MCR.Solr.TikaFields</code>
                    </td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.NestedDocuments
                    </td>
                    <td>default=true; <br/>aktiviert den Support für Nested Documents</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.ObserverConfigTypes
                    </td>
                    <td>default=requestHandler,searchComponent</td>
                    <td/>
                </tr>
                <tr>
                    <td>
                        MCR.Solr.HTTPResponseHeader.Content-Security-Policy
                    </td>
                    <td>das Property ist nicht gesetzt</td>
                    <td/>
                </tr>
                </tbody>
            </table>
        </div>

        <h2>Solr Kommandos für die MyCoRe CLI</h2>
        <p>
            Folgende Kommandos stehen für die Arbeit mit Solr an der Kommandozeile zur Verfügung.
            <strong class="text-warning">Bitte beachten Sie Folgendes bei der Arbeit mit SOLR-Kommandos: Verwenden Sie
                die CLI (mycore.sh) stets im interaktiven Modus. Andernfalls besteht die Gefahr, dass Operationen nicht
                vollständig ausgeführt werden!</strong>
            Die Core ID für den Standard Solr Core in MyCoRe ist
            <code>main</code>.
        </p>
        <h3>Solr-Cloud Commands</h3>
        <div class="table-responsive">
            <table class="table">
                <thead>
                <tr>
                    <th>Kommando-Name</th>
                    <th>Beschreibung</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>show remote config sets</td>
                    <td>Zeigt die Namen der Konfigurationssets auf dem Remote-Solr-Server an.</td>
                </tr>
                <tr>
                    <td>show local config sets</td>
                    <td>Zeigt die in den MyCoRe-Einstellungen definierten Konfigurationssets an.</td>
                </tr>
                <tr>
                    <td>delete remote config set for {0}</td>
                    <td>Sucht das für den angegebenen Core {0} verwendete Konfigurationsset in den MyCoRe-Einstellungen
                        und löscht es vom Remote-Solr-Server.
                    </td>
                </tr>
                <tr>
                    <td>upload local config set for {0}</td>
                    <td>Sucht das für den angegebenen Core {0} verwendete Konfigurationsset in den MyCoRe-Einstellungen
                        und lädt es auf den Remote-Solr-Server hoch.
                    </td>
                </tr>
                <tr>
                    <td>create collection for core {0}</td>
                    <td>Erstellt eine neue Collection auf dem Remote-Solr-Server unter Verwendung des in den
                        MyCoRe-Einstellungen definierten Konfigurationssets für den Core {0}.
                    </td>
                </tr>
                <tr>
                    <td>remove collection for core {0}</td>
                    <td>Entfernt eine Collection auf dem Remote-Solr-Server unter Verwendung des in den
                        MyCoRe-Einstellungen definierten Konfigurationssets für den Core {0}.
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <h3>SOLR Core Admin Commands</h3>
        <div class="table-responsive">
            <table class="table">
                <thead>
                <tr>
                    <th>Kommando-Name</th>
                    <th>Beschreibung</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>show solr configuration</td>
                    <td>Zeigt die MyCoRe-Properties für die aktuelle Solr-Konfiguration an.</td>
                </tr>
                <tr>
                    <td>register solr core with name {0} as core {1}</td>
                    <td>Konfiguriert einen Solr-Core mit dem core_name {0} als core_id {1} in MyCoRe.</td>
                </tr>
                <tr>
                    <td>add type {0} to solr core {1}</td>
                    <td>Fügt einem Solr-Core einen Typ hinzu, sodass Dokumente dieses Typs in diesem Core indexiert
                        werden. Der Typ kann z.B. 'main' oder 'classification' sein.
                    </td>
                </tr>
                <tr>
                    <td>remove type {0} from solr core {1}</td>
                    <td>Entfernt einen Typ aus einem Solr-Core, sodass Dokumente dieses Typs nicht mehr in diesem Core
                        indexiert werden. Der Typ kann 'main' oder 'classification' sein.
                    </td>
                </tr>
                <tr>
                    <td>switch solr core {0} with core {1}</td>
                    <td>Tauscht die Konfigurationen zwischen zwei Solr-Cores aus.</td>
                </tr>
                <tr>
                    <td>set shard count {0} for solr core {1}</td>
                    <td>Setzt die Anzahl der Shards für einen Solr-Core. Diese Anzahl wird nicht sofort auf dem
                        Solr-Server aktualisiert, sondern verwendet, wenn der Core erstellt wird.
                    </td>
                </tr>
                <tr>
                    <td>set configset {0} for solr core {1}</td>
                    <td>Setzt das ConfigSet für einen Solr-Core. Das ConfigSet wird nicht sofort auf dem Solr-Server
                        aktualisiert, sondern verwendet, wenn der Core erstellt wird.
                    </td>
                </tr>
                <tr>
                    <td>set server {0} for solr core {1}</td>
                    <td>Setzt den Server für einen Solr-Core. Der Server wird nicht sofort auf dem Solr-Server
                        aktualisiert, sondern verwendet, wenn der Core erstellt wird.
                    </td>
                </tr>
                <tr>
                    <td>reload solr configuration {0} in core {1}</td>
                    <td>Lädt das Schema und die Konfiguration in Solr neu, indem die Solr-Schema-API für den Core mit
                        der
                        ID {0} verwendet wird.
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <h3>SOLR Index and Search Commands</h3>
        <div class="table-responsive">
            <table class="table">
                <thead>
                <tr>
                    <th>Kommando-Name</th>
                    <th>Beschreibung</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>rebuild solr metadata and content index in core {0}</td>
                    <td>Erstellt den Metadaten- und Inhaltsindex in Solr für den Core mit der ID {0} neu.</td>
                </tr>
                <tr>
                    <td>rebuild solr metadata index for all objects of type {0} in core {1}</td>
                    <td>Erstellt den Metadatenindex in Solr für alle Objekte mit der type id {0} im Core mit der ID {1}
                        neu.
                    </td>
                </tr>
                <tr>
                    <td>rebuild solr metadata index for all objects of base {0} in core {1}</td>
                    <td>Erstellt den Metadatenindex in Solr für alle Objekte mit der basis id {0} im Core mit der ID {1}
                        neu.
                    </td>
                </tr>
                <tr>
                    <td>rebuild solr metadata index for object {0} in core {1}</td>
                    <td>Erstellt den Metadatenindex in Solr für das angegebene Objekt mit der id {0} im Core mit der ID
                        {1} neu.
                    </td>
                </tr>
                <tr>
                    <td>select objects with solr query {0} in core {1}</td>
                    <td>Wählt MyCoRe-Objekte mit einer Solr-Abfrage {0} im Core mit der ID {1} aus.</td>
                </tr>
                <tr>
                    <td>rebuild solr metadata index for selected in core {0}</td>
                    <td>Erstellt den Metadatenindex in Solr für ausgewählte Objekte oder Derivate im Core mit der ID {0}
                        neu.
                    </td>
                </tr>
                <tr>
                    <td>rebuild solr metadata index in core {0}</td>
                    <td>Indexiert alle Objekte im Core mit der ID {0}.</td>
                </tr>
                <tr>
                    <td>rebuild solr content index for object {0} in core {1}</td>
                    <td>Indexiert alle Derivate des Objekts mit der ID {0} im Core mit der ID {1}.</td>
                </tr>
                <tr>
                    <td>rebuild solr content index for selected in core {0}</td>
                    <td>Indexiert alle Derivate der ausgewählten Objekte im Core mit der ID {0}.</td>
                </tr>
                <tr>
                    <td>rebuild solr content index in core {0}</td>
                    <td>Indexiert alle Derivate in Solr im Core mit der ID {0}.</td>
                </tr>
                <tr>
                    <td>rebuild solr classification index in core {0}</td>
                    <td>Indexier alles Klassifikationen in Solr im Core mit der ID {0} neu.</td>
                </tr>
                <tr>
                    <td>clear solr index in core {0}</td>
                    <td>Löscht alle Einträge aus dem Index in Solr im Core mit der ID {0}.</td>
                </tr>
                <tr>
                    <td>delete from solr index all objects of type {0} in core {1}</td>
                    <td>Löscht alle Objekte des Typs {0} aus dem Index in Solr im Core mit der ID {1}.</td>
                </tr>
                <tr>
                    <td>delete from solr index all objects of base {0} in core {1}</td>
                    <td>Löscht alle Objekte des Basis {0} aus dem Index in Solr im Core mit der ID {1}.</td>
                </tr>
                <tr>
                    <td>delete from solr index object {0} in core {1}</td>
                    <td>Löscht ein Objekt mit der ID {0} aus dem Index in Solr im Core mit der ID {1}.</td>
                </tr>
                <tr>
                    <td>optimize solr index in core {0}</td>
                    <td>Optimiert den Index in Solr im Core mit der ID {0}. Diese Operation sollte aufgrund ihrer hohen
                        Kosten selten durchgeführt werden.
                    </td>
                </tr>
                <tr>
                    <td>synchronize solr metadata index for all objects of type {0} in core {1}</td>
                    <td>Synchronisiert den MyCoRe-Store und den Index in Solr im Core mit der ID {1} für Objekte des
                        Typs
                        {0}.
                    </td>
                </tr>
                <tr>
                    <td>synchronize solr metadata index for all objects of base {0} in core {1}</td>
                    <td>Synchronisiert den MyCoRe-Store und den Index in Solr im Core mit der ID {1} für Objekte des
                        Basis
                        {0}.
                    </td>
                </tr>
                <tr>
                    <td>synchronize solr metadata index in core {0}</td>
                    <td>Synchronisiert den MyCoRe-Store und den Index in Solr im Core mit der ID {0}.</td>
                </tr>
                </tbody>
            </table>
        </div>

        <h2>Solr-Abfragen über die MyCoRe-Java-API</h2>
        <p>
            Mit diesem Code-Schnipsel soll demonstriert werden, wie ein Zugriff auf die Solr-Daten mittels MyCoRe-API
            erfolgen kann. Seit MyCoRe 2024.06 LTS unterstützt MyCoRe die Authentifizierung für Solr-Abfragen, deshalb
            sollte die Authentifizierung für die Abfrage angewendet werden. Dafür wird die Klasse
            <code>MCRSolrAuthenticationManager</code> genutzt.
            Sie bietet die Möglichkeit, die in MyCoRe konfigurierte Authentifizierung zu einem <code>SolrRequest</code>
            oder
            zu einem <code>HttpRequest.Builder</code> hinzuzufügen.
        </p>

        <h3>Bis 2023.06 LTS</h3>

{{< highlight java "linenos=table">}}
 import org.apache.solr.client.solrj.SolrClient;
 import org.apache.solr.client.solrj.SolrQuery;
 import org.apache.solr.client.solrj.SolrServerException;
 import org.apache.solr.common.SolrDocumentList;
 import org.mycore.solr.MCRSolrClientFactory;
 import org.mycore.solr.MCRSolrUtils;

 ...
 SolrClient solrClient = MCRSolrClientFactory.getMainSolrClient();
 //oder:
 SolrClient solrClient = MCRSolrClientFactory.get("{coreID}").getClient();

 SolrQuery query = new SolrQuery();
 query.setQuery("title:foo");
 query.setRows(10);
 SolrDocumentList results = solrClient.query(query).getResults();
 ...
{{< /highlight >}}


        <h3>Ab 2024.06 LTS</h3>

{{< highlight java "linenos=table">}}
 import org.apache.solr.client.solrj.SolrClient;
 import org.apache.solr.client.solrj.SolrQuery;
 import org.apache.solr.client.solrj.SolrServerException;
 import org.apache.solr.client.solrj.request.QueryRequest;
 import org.apache.solr.client.solrj.response.QueryResponse;
 import org.apache.solr.common.SolrDocumentList;
 import org.apache.solr.common.SolrInputDocument;
 import org.mycore.solr.auth.MCRSolrAuthenticationManager;

 ...
 SolrClient solrClient = MCRSolrCoreManager.getMainSolrClient();
 //oder:
 SolrClient solrClient = MCRSolrCoreManager.get("{coreID}").get().getClient();

 SolrQuery query = new SolrQuery();
 query.setQuery("title:foo");
 query.setRows(10);
 QueryRequest queryRequest = new QueryRequest(query);
 MCRSolrAuthenticationManager.getInstance().applyAuthentication(queryRequest, MCRSolrAuthenticationLevel.SEARCH);

 try {
   QueryResponse process = queryRequest.process(solrClient);
   SolrDocumentList results = process.getResults();
 } catch (SolrServerException e) {
   throw new RuntimeException(e); // handle this
 }

 ...
{{< /highlight >}}
