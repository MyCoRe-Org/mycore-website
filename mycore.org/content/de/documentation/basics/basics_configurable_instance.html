---

title: "Konfigurierbare Klasseninstanzen"
mcr_version: ['2021.06']
author: ['Sebastian Hofmann']
description: "
Oft ist es nötig Implementierungen auszutauschen, diese Implementierungen benötigen oft zusätzliche
Properties. Um die Austauschbarkeit und das Zuweisen von weiteren Properties zu vereinfachen, ist es möglich
Instanzen einer Klasse mit der Angabe eines Properties von MyCoRe erzeugen zu lassen.
"
date: '2021-09-08'

---
<!--
  ~ This file is part of ***  M y C o R e  ***
  ~ See http://www.mycore.de/ for details.
  ~
  ~ MyCoRe is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU General Public License as published by
  ~ the Free Software Foundation, either version 3 of the License, or
  ~ (at your option) any later version.
  ~
  ~ MyCoRe is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU General Public License for more details.
  ~
  ~ You should have received a copy of the GNU General Public License
  ~ along with MyCoRe.  If not, see <http://www.gnu.org/licenses/>.
  -->

<div>
    <h2>Erzeugen einer Instanz</h2>
    <p>
        Für das Erzeugen einer Instanz kann die statische Methode <code>getInstanceOf</code> in der Klasse
        <code>MCRConfiguration2</code> mit einem frei wählbaren Konfigurationsnamen aufgerufen werden.
    </p>
{{< highlight java "linenos=table">}}
Optional<MyConfigurableClass> configuredClass = MCRConfiguration2.getInstanceOf("MCR.Configurable.Class");
{{< /highlight >}}
    <p>
        Damit eine entsprechende Instanz erzeugt werden kann, muss ein entsprechendes Property die zu instanziierende Klasse als mit einem vollqualifizierten Klassennamen benennen.
        Optional kann der Zusatz <code>.class</code> angegeben werden.
        Die entsprechende Klasse darf nicht abstrakt sein und muss einen parameterlosen Konstruktor anbieten. Diese muss <code>public</code> sein.
    </p>
{{< highlight bash "linenos=table">}}
# MCR.Configurable.Class=de.my.configurable.MyConfigurableClass.class
MCR.Configurable.Class=de.my.configurable.MyConfigurableClass
{{< /highlight >}}

    <h2>Zuweisen von Properties mit @MCRProperty</h2>
    <p>
        Falls die Klasse <code>MyConfigurableClass</code> zusätzliche Properties benötigt, so können Felder oder Methoden mit der Annotation <code>@MCRProperty</code> versehen werden.
        Annotierte Felder muss <code>public</code> und vom Typ <code>String</code> oder <code>Map&lt;String, String&gt;</code> sein.
        Annotierte Methoden muss <code>public</code> sein und einen einzigen Parameter vom Typ <code>String</code> oder <code>Map&lt;String, String&gt;</code> nehmen.
    </p>
    <p>
        Die Annotation hat folgende Konfigurationsmöglichkeiten:
        <ul>
            <li>
                Das notwendige Attribut <code>mame</code> gibt den Namen des zugehörigen Properties an, sofern das annotierte Feld bzw. die annotierte Methode den Typ <code>String</code> nutzt.
                Genau dann, wenn das annotierte Feld bzw. die annotierte Methode den Typ <code>Map&lt;String, String&gt;</code> nutzt, muss hier der besondere Wert <code>*</code> angegeben werden.
                In diesem Fall wird statt einem einzelnen Property eine <code>Map</code> mit allen unterhalb des gewählten Konfigurationsnamens vorhandenen Properties bereitgestellt.
            </li>
            <li>
                Das optional Attribut <code>required</code> gibt an, ob ein entsprechendes Property vorhanden sein muss.
                Der Standardwert ist <code>true</code>.
                Wenn <code>false</code> gewählt wird und kein entsprechendes Property vorhanden ist, wird der (z.B. im Konstruktor gesetzte) vorhandene Wert des annotierten Feldes nicht auf <code>null</code> gesetzt.
                Eine annotierte Methode wird in diesem Fall nicht aufgerufen. Wird eine annotierte Methode aufgerufen, so ist der übergebene Wert niemals <code>null</code>.
            </li>
            <li>
                Das optionale Attribut <code>absolute</code> gibt an, ob der unter <code>name</code> angegeben Wert absolute (und nicht relativ zum Konfigurationsnamen) aufgefasst werden soll.
            </li>
            <li>
                Das optionale Attribut <code>defaultName</code> gibt den absolut aufgefassten Namen eines Standardproperties an, dass verwendet werden soll, wenn das eigentliche Property nicht vorhanden ist.
                Dieses Standardproperty muss auf jeden Fall konfiguriert sein.
                Dieses Vorgehen ist hart kodierten Standardwerten vorzuziehen.
            </li>
            <li>
                Das optionale Attribut <code>order</code> gibt die Reihenfolge an, in der die annotierten Felder gesetzt bzw. die annotierten Methoden aufgerufen werden, wobei niedrigere bevorzugt werden.
                Der Standardwert ist <code>0</code>. Haben z.B. mehrere annotierte Methoden denselben Wert, so wird keine Reihenfolge garantiert.
            </li>
        </ul>
    </p>

    <p>
        Java-Code in der Klasse <code>MyConfigurableClass</code> (Auszug):
    </p>
    {{< highlight java "linenos=table">}}
@MCRProperty(name = "Foo", required = false)
public String foo = "default";

@MCRProperty(name = "*")
public Map<String, String> map;

private Integer number;

@MCRProperty(name = "MCR.InterestingNumber.Local", absolute=true, defaultName="MCR.InterestingNumber.Global")
public void setNumber(String number){
    this.foo = Integer.parseInt(number);
}{{< /highlight >}}

    <p>
        Eine passende Konfiguration könnte beispielsweise so aussehen:
    </p>
{{< highlight bash "linenos=table">}}
MCR.Configurable.Class=de.my.configurable.MyConfigurableClass
MCR.Configurable.Class.Foo=custom
MCR.Configurable.Class.Bar=baz
# MCR.InterestingNumber.Local=23
MCR.InterestingNumber.Global=42{{< /highlight >}}
    <p>
        In diesem Beispiel bekommt das Feld <code>foo</code> den Wert <code>custom</code> aus dem Property <code>MCR.Configurable.Class.Foo</code>.
        Der vordefiniert Wert <code>default</code> wird überschrieben.
        Das Feld <code>map</code> bekommt eine <code>Map</code> mit den Einträgen <code>Foo=custom</code> und <code>Bar=baz</code>.
        Die Methode <code>setNumber</code> wird mit dem Wert <code>42</code> aus dem Standardproperty <code>MCR.InterestingNumber.Global</code> aufgerufen.
        Wäre das Property <code>MCR.InterestingNumber.Local</code> nicht auskommentiert, so würde die Methode mit dessen Wert <code>23</code> aufgerufen werden.
    </p>

    <h2>Abschließende Initialisierung mit @MCRPostConstruction</h2>
    <p>
        Da man Felder eines Objektes nicht zuweisen kann bevor der Konstruktor aufgerufen wurde, man jedoch für die
        Initialisierung möglicherweise die zugewiesenen Felder benötigt, gibt es die Möglichkeit weitere Methoden
        nach der Initialisierung aufrufen zu lassen. Dazu muss die Methode <code>public</code> sein, entweder keinen
        oder genau einen Parameter vom Typ <code>String</code> nehmen und mit <code>@MCRPostConstruction</code>
        annotiert sein. Die Annotation hat ein optionale Attribut <code>order</code> das analog zum gleichnamigen
        Attribut von <code>@MCRProperty</code> funktioniert.
    </p>
    <p>
        Java-Code in der Klasse <code>MyConfigurableClass</code> (Auszug):
    </p>
    {{< highlight java "linenos=table">}}
@MCRPostConstruction
public void init(String property) {
  assert this.foo!=null;
} {{< /highlight >}}
    <p>
        Falls die Methode einen Parameter nimmt, so wird der Konfigurationsnamen übergeben.
        Im Beispiel also <code>MCR.Configurable.Class</code>.
    </p>

    <h2>Initialisierungsreihenfolge</h2>
    <p>
        Die Reihenfolge der Initialisierung ist:
    </p>
    <ol>
        <li>Aufrufen des Konstruktors</li>
        <li>Zuweisung der mit <code>@MCRProperty</code> annotierten Felder (in aufsteigenden <code>order</code>-Reihenfolge)</li>
        <li>Aufrufen der mit <code>@MCRProperty</code> annotierten Methoden (in aufsteigenden <code>order</code>-Reihenfolge)</li>
        <li>Aufrufen der mit <code>@MCRPostConstruction</code> annotierten Methode (in aufsteigenden <code>order</code>-Reihenfolge)</li>
    </ol>

</div>